openapi: 3.0.3
info:
  title: HandsFree Dev Companion API
  version: 1.0.0
  description: >
    API contract for a hands-free developer assistant (wearable/phone -> backend).
    Designed for fixture-driven testing and safe, policy-gated side effects.
servers:
  - url: http://localhost:8080
paths:
  /v1/command:
    post:
      summary: Submit a hands-free command (text or audio metadata)
      operationId: submitCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
      responses:
        '200':
          description: Command handled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/commands/confirm:
    post:
      summary: Confirm a previously proposed side-effect action
      operationId: confirmCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmRequest'
      responses:
        '200':
          description: Confirmation processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '404':
          description: Pending action not found/expired
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/inbox:
    get:
      summary: Get attention items (PRs, mentions, failing checks)
      operationId: getInbox
      parameters:
        - in: query
          name: profile
          schema: { $ref: '#/components/schemas/Profile' }
          required: false
      responses:
        '200':
          description: Inbox items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InboxResponse'

  /v1/status:
    get:
      summary: Get service status
      operationId: getStatus
      description: >
        Lightweight health/status endpoint for the mobile app and simulator.
        Returns service status, version, timestamp, and dependency readiness
        (e.g., DuckDB). Does not expose sensitive configuration values.
      responses:
        '200':
          description: Service status information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  /v1/metrics:
    get:
      summary: Get observability metrics
      operationId: getMetrics
      description: >
        Returns lightweight observability metrics for the command flow.
        Gated behind HANDSFREE_ENABLE_METRICS environment variable.
        Includes command latency percentiles (p50/p95), intent counts,
        status counts, and confirmation outcomes.
      responses:
        '200':
          description: Metrics snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsSnapshot'
        '404':
          description: Metrics not enabled
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/webhooks/github:
    post:
      summary: Receive GitHub webhooks (verified by signature)
      operationId: githubWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Raw GitHub webhook payload
      responses:
        '202':
          description: Accepted
        '400':
          description: Invalid payload or signature
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/webhooks/retry/{event_id}:
    post:
      summary: Retry processing a webhook event (dev-only)
      operationId: retryWebhookProcessing
      description: >
        Retries normalization and notification emission for a failed webhook event.
        This endpoint is only available in dev mode and is useful for recovering
        from transient failures during webhook processing.
      parameters:
        - name: event_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: The webhook event ID to retry
      responses:
        '200':
          description: Retry completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  event_id:
                    type: string
                    format: uuid
                  status:
                    type: string
                    enum: [success, failed, skipped]
                    description: The status of the retry attempt
                  message:
                    type: string
                    description: A message describing the retry result
        '403':
          description: Forbidden - not in dev mode
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Event not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/actions/request-review:
    post:
      summary: Request reviewers on a PR (policy-gated)
      operationId: requestReview
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RequestReviewRequest' }
      responses:
        '200':
          description: Review request submitted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }
        '409':
          description: Policy denied or needs confirmation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/actions/rerun-checks:
    post:
      summary: Re-run CI checks (policy-gated)
      operationId: rerunChecks
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RerunChecksRequest' }
      responses:
        '200':
          description: Re-run triggered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }

  /v1/actions/merge:
    post:
      summary: Merge a PR (strict policy gate + confirmation)
      operationId: mergePr
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MergeRequest' }
      responses:
        '200':
          description: Merge submitted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }
        '409':
          description: Policy denied or needs confirmation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/tts:
    post:
      summary: Convert text to speech (TTS)
      operationId: textToSpeech
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TTSRequest'
      responses:
        '200':
          description: Audio file generated successfully
          content:
            audio/wav:
              schema:
                type: string
                format: binary
            audio/mpeg:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid request (empty or too long text)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: TTS synthesis failed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/dev/audio:
    post:
      summary: Upload audio bytes for dev/testing (dev-only)
      operationId: uploadDevAudio
      description: >
        Accepts base64-encoded audio and saves it locally, returning a file:// URI.
        Only available when HANDSFREE_AUTH_MODE=dev.
        Use the returned URI with POST /v1/command for testing audio commands.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [data_base64]
              properties:
                data_base64:
                  type: string
                  description: Base64-encoded audio bytes
                format:
                  type: string
                  enum: [wav, m4a, mp3, opus]
                  default: m4a
                  description: Audio format/extension
      responses:
        '200':
          description: Audio uploaded successfully
          content:
            application/json:
              schema:
                type: object
                required: [uri, bytes, format, user_id]
                properties:
                  uri:
                    type: string
                    format: uri
                    description: file:// URI for the uploaded audio
                  bytes:
                    type: integer
                    description: Size of audio in bytes
                  format:
                    type: string
                    description: Audio format
                  user_id:
                    type: string
                    description: User ID that uploaded the audio
        '400':
          description: Invalid request (missing/invalid data_base64, bad format, or too large)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Forbidden (not in dev mode)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/repos/subscriptions:
    post:
      summary: Create a repository subscription for webhook notifications
      operationId: createRepoSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRepoSubscriptionRequest'
      responses:
        '201':
          description: Subscription created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RepoSubscriptionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    get:
      summary: List repository subscriptions for the current user
      operationId: listRepoSubscriptions
      responses:
        '200':
          description: List of subscriptions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RepoSubscriptionsListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/repos/subscriptions/{repo_full_name}:
    delete:
      summary: Delete a repository subscription
      operationId: deleteRepoSubscription
      parameters:
        - name: repo_full_name
          in: path
          required: true
          schema:
            type: string
          description: Full repository name (e.g., "owner/repo")
      responses:
        '204':
          description: Subscription deleted successfully
        '404':
          description: Subscription not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/notifications:
    get:
      summary: List notifications for the current user (polling)
      operationId: listNotifications
      parameters:
        - name: since
          in: query
          required: false
          schema:
            type: string
          description: Optional ISO 8601 timestamp; return notifications after this time.
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
          description: Maximum number of notifications to return.
      responses:
        '200':
          description: Notifications list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationsListResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/notifications/{notification_id}:
    get:
      summary: Get a specific notification by ID
      operationId: getNotification
      parameters:
        - name: notification_id
          in: path
          required: true
          schema:
            type: string
          description: The ID of the notification to retrieve.
      responses:
        '200':
          description: Notification details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Notification'
        '404':
          description: Notification not found or does not belong to the user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/notifications/subscriptions:
    post:
      summary: Register a push subscription/device token
      operationId: createNotificationSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateNotificationSubscriptionRequest'
      responses:
        '201':
          description: Subscription created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSubscriptionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    get:
      summary: List push subscriptions/device tokens
      operationId: listNotificationSubscriptions
      responses:
        '200':
          description: List of subscriptions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NotificationSubscriptionsListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/notifications/subscriptions/{subscription_id}:
    delete:
      summary: Unregister a push subscription/device token
      operationId: deleteNotificationSubscription
      parameters:
        - name: subscription_id
          in: path
          required: true
          schema:
            type: string
          description: Subscription UUID
      responses:
        '204':
          description: Subscription deleted successfully
        '404':
          description: Subscription not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/agents/tasks/{task_id}/start:
    post:
      summary: Start an agent task (dev-only)
      description: |
        Transition a task from 'created' to 'running' state.
        This endpoint is only available in dev mode (HANDSFREE_AUTH_MODE=dev).
      operationId: startAgentTask
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
          description: The task ID to start
      responses:
        '200':
          description: Task started successfully
          content:
            application/json:
              schema:
                type: object
                required: [task_id, state, updated_at, message]
                properties:
                  task_id:
                    type: string
                  state:
                    type: string
                    enum: [running]
                  updated_at:
                    type: string
                    format: date-time
                  message:
                    type: string
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Endpoint disabled (not in dev mode)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Task not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/agents/tasks/{task_id}/complete:
    post:
      summary: Complete an agent task (dev-only)
      description: |
        Transition a task from 'running' to 'completed' state.
        This endpoint is only available in dev mode (HANDSFREE_AUTH_MODE=dev).
      operationId: completeAgentTask
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
          description: The task ID to complete
      responses:
        '200':
          description: Task completed successfully
          content:
            application/json:
              schema:
                type: object
                required: [task_id, state, updated_at, message]
                properties:
                  task_id:
                    type: string
                  state:
                    type: string
                    enum: [completed]
                  updated_at:
                    type: string
                    format: date-time
                  message:
                    type: string
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Endpoint disabled (not in dev mode)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Task not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/agents/tasks/{task_id}/fail:
    post:
      summary: Fail an agent task (dev-only)
      description: |
        Transition a task to 'failed' state from 'created', 'running', or 'needs_input'.
        This endpoint is only available in dev mode (HANDSFREE_AUTH_MODE=dev).
      operationId: failAgentTask
      parameters:
        - name: task_id
          in: path
          required: true
          schema:
            type: string
          description: The task ID to fail
      responses:
        '200':
          description: Task failed successfully
          content:
            application/json:
              schema:
                type: object
                required: [task_id, state, updated_at, message]
                properties:
                  task_id:
                    type: string
                  state:
                    type: string
                    enum: [failed]
                  updated_at:
                    type: string
                    format: date-time
                  message:
                    type: string
        '400':
          description: Invalid state transition
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Endpoint disabled (not in dev mode)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '404':
          description: Task not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/github/oauth/start:
    get:
      summary: Start GitHub OAuth flow
      operationId: startGitHubOAuth
      description: >
        Initiates GitHub OAuth flow by returning an authorization URL.
        The user should be redirected to this URL to authorize the app.
      responses:
        '200':
          description: OAuth flow started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubOAuthStartResponse'
        '500':
          description: OAuth configuration error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/github/oauth/callback:
    get:
      summary: Handle GitHub OAuth callback
      operationId: handleGitHubOAuthCallback
      description: >
        Handles the OAuth callback from GitHub after user authorization.
        Exchanges the authorization code for an access token and creates a connection.
      parameters:
        - name: code
          in: query
          required: true
          schema:
            type: string
          description: Authorization code from GitHub
        - name: state
          in: query
          required: false
          schema:
            type: string
          description: State parameter for CSRF protection
      responses:
        '200':
          description: OAuth completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubOAuthCallbackResponse'
        '400':
          description: Invalid callback (missing code, state mismatch, etc.)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: Token exchange or connection creation failed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/github/connections:
    post:
      summary: Create a GitHub connection
      operationId: createGitHubConnection
      description: >
        Creates a new GitHub connection for the authenticated user.
        Accepts either a token or token_ref for secure token storage.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGitHubConnectionRequest'
      responses:
        '201':
          description: Connection created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubConnectionResponse'
        '400':
          description: Invalid request (missing both token and token_ref, or both provided)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    get:
      summary: List GitHub connections for user
      operationId: listGitHubConnections
      description: >
        Returns all GitHub connections for the authenticated user.
      responses:
        '200':
          description: List of connections
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubConnectionsListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/github/connections/{connection_id}:
    get:
      summary: Get a specific GitHub connection
      operationId: getGitHubConnection
      parameters:
        - name: connection_id
          in: path
          required: true
          schema:
            type: string
          description: Connection ID
      responses:
        '200':
          description: Connection details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubConnectionResponse'
        '404':
          description: Connection not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    delete:
      summary: Delete a GitHub connection
      operationId: deleteGitHubConnection
      parameters:
        - name: connection_id
          in: path
          required: true
          schema:
            type: string
          description: Connection ID
      responses:
        '204':
          description: Connection deleted successfully
        '404':
          description: Connection not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/admin/api-keys:
    post:
      summary: Create an API key (admin)
      operationId: createApiKey
      description: >
        Creates a new API key for the authenticated user.
        Only available to admin users.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApiKeyRequest'
      responses:
        '201':
          description: API key created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateApiKeyResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    get:
      summary: List API keys (admin)
      operationId: listApiKeys
      description: >
        Lists all API keys for the authenticated user.
        Only available to admin users.
      parameters:
        - name: include_revoked
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Include revoked keys in the response
      responses:
        '200':
          description: List of API keys
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiKeysListResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/admin/api-keys/{key_id}:
    delete:
      summary: Revoke an API key (admin)
      operationId: revokeApiKey
      description: >
        Revokes an API key by marking it as revoked.
        Only available to admin users.
      parameters:
        - name: key_id
          in: path
          required: true
          schema:
            type: string
          description: API key ID
      responses:
        '204':
          description: API key revoked successfully
        '404':
          description: API key not found
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '403':
          description: Forbidden (not admin)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

components:
  schemas:
    Profile:
      type: string
      enum: [workout, kitchen, commute, default]
      default: default

    PrivacyMode:
      type: string
      enum: [strict, balanced, debug]
      default: strict
      description: >
        Privacy mode controls data exposure in responses:
        - strict: No images, no code snippets, summaries only (default)
        - balanced: Small excerpts permitted with redaction
        - debug: Verbose (never default), includes more diagnostics

    CommandRequest:
      type: object
      required: [input, profile, client_context]
      properties:
        input:
          $ref: '#/components/schemas/CommandInput'
        profile:
          $ref: '#/components/schemas/Profile'
        client_context:
          $ref: '#/components/schemas/ClientContext'
        idempotency_key:
          type: string
          description: Client-provided idempotency key for de-duping.

    CommandInput:
      type: object
      oneOf:
        - $ref: '#/components/schemas/TextInput'
        - $ref: '#/components/schemas/AudioInput'
        - $ref: '#/components/schemas/ImageInput'
      discriminator:
        propertyName: type
        mapping:
          text: '#/components/schemas/TextInput'
          audio: '#/components/schemas/AudioInput'
          image: '#/components/schemas/ImageInput'

    TextInput:
      type: object
      required: [type, text]
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string
          maxLength: 2000

    AudioInput:
      type: object
      required: [type, format, uri]
      properties:
        type:
          type: string
          enum: [audio]
        format:
          type: string
          enum: [wav, m4a, mp3, opus]
        uri:
          type: string
          description: Where the backend can fetch the audio (pre-signed URL) or a local dev placeholder.
        duration_ms:
          type: integer
          minimum: 0

    ImageInput:
      type: object
      required: [type, uri]
      properties:
        type:
          type: string
          enum: [image]
        uri:
          type: string
          description: URI to the image/camera snapshot (pre-signed URL or local dev placeholder). Not fetched or processed yet.
        content_type:
          type: string
          description: MIME type of the image (e.g., image/jpeg, image/png)
          example: image/jpeg

    ClientContext:
      type: object
      required: [device, locale, timezone, app_version]
      properties:
        device:
          type: string
          description: e.g. ios, android, simulator
        locale:
          type: string
          example: en-US
        timezone:
          type: string
          example: America/Los_Angeles
        app_version:
          type: string
          example: 0.1.0
        noise_mode:
          type: boolean
          default: false
        debug:
          type: boolean
          default: false
          description: Enable debug mode to store transcript for troubleshooting
        privacy_mode:
          $ref: '#/components/schemas/PrivacyMode'

    CommandResponse:
      type: object
      required: [spoken_text, intent, status]
      properties:
        status:
          type: string
          enum: [ok, needs_confirmation, error]
        intent:
          $ref: '#/components/schemas/ParsedIntent'
        spoken_text:
          type: string
          description: Text that should be sent to TTS.
        cards:
          type: array
          items: { $ref: '#/components/schemas/UICard' }
        pending_action:
          $ref: '#/components/schemas/PendingAction'
        debug:
          $ref: '#/components/schemas/DebugInfo'

    ParsedIntent:
      type: object
      required: [name, confidence]
      properties:
        name:
          type: string
          example: inbox.list
          description: >
            Intent name parsed from the command. Supported intents include:
            - inbox.list: Query inbox items
            - pr.summarize: Summarize a pull request
            - pr.merge: Merge a pull request (policy-gated)
            - agent.delegate: Delegate a task to an agent
            - agent.status: Query status of agent tasks
        confidence:
          type: number
          minimum: 0
          maximum: 1
        entities:
          type: object
          additionalProperties: true
          description: >
            Extracted entities specific to the intent. Examples:
            - pr_number (int): PR number for pr.* intents
            - issue_number (int): Issue number for agent.delegate
            - task_id (string): Agent task ID for agent.delegate
            - instruction (string): Task instruction for agent.delegate

    PendingAction:
      type: object
      required: [token, expires_at, summary]
      properties:
        token:
          type: string
        expires_at:
          type: string
          format: date-time
        summary:
          type: string
          description: Human-readable action summary for confirmation.

    UICard:
      type: object
      required: [title]
      properties:
        title:
          type: string
        subtitle:
          type: string
        lines:
          type: array
          items: { type: string }
        deep_link:
          type: string
          description: Optional link to open on phone.

    DebugInfo:
      type: object
      properties:
        transcript:
          type: string
        tool_calls:
          type: array
          items:
            type: object
            additionalProperties: true

    ConfirmRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
        idempotency_key:
          type: string

    InboxResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/InboxItem' }

    InboxItem:
      type: object
      required: [type, title, priority]
      properties:
        type:
          type: string
          enum: [pr, mention, check, agent]
        title:
          type: string
        priority:
          type: integer
          minimum: 1
          maximum: 5
        repo:
          type: string
        url:
          type: string
        summary:
          type: string
        checks_passed:
          type: integer
          minimum: 0
          description: Number of checks that passed
        checks_failed:
          type: integer
          minimum: 0
          description: Number of checks that failed
        checks_pending:
          type: integer
          minimum: 0
          description: Number of checks that are pending or in progress

    RequestReviewRequest:
      type: object
      required: [repo, pr_number, reviewers]
      properties:
        repo: { type: string, example: owner/name }
        pr_number: { type: integer, minimum: 1 }
        reviewers:
          type: array
          items: { type: string }
        idempotency_key: { type: string }

    RerunChecksRequest:
      type: object
      required: [repo, pr_number]
      properties:
        repo: { type: string }
        pr_number: { type: integer, minimum: 1 }
        idempotency_key: { type: string }

    MergeRequest:
      type: object
      required: [repo, pr_number]
      properties:
        repo: { type: string }
        pr_number: { type: integer, minimum: 1 }
        merge_method:
          type: string
          enum: [merge, squash, rebase]
          default: squash
        idempotency_key: { type: string }

    ActionResult:
      type: object
      required: [ok, message]
      properties:
        ok: { type: boolean }
        message: { type: string }
        url: { type: string }

    Error:
      type: object
      required: [error, message]
      properties:
        error: { type: string }
        message: { type: string }
        details:
          type: object
          additionalProperties: true

    DependencyStatus:
      type: object
      required: [name, status]
      properties:
        name:
          type: string
          description: Name of the dependency (e.g., duckdb, redis)
        status:
          type: string
          enum: [ok, degraded, unavailable]
          description: Status of the dependency
        message:
          type: string
          description: Optional message with additional details

    StatusResponse:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [ok, degraded, unavailable]
          description: Overall service status
        version:
          type: string
          description: Service version if available
        timestamp:
          type: string
          format: date-time
          description: Current server time (ISO 8601)
        dependencies:
          type: array
          items:
            $ref: '#/components/schemas/DependencyStatus'
          description: Status of service dependencies

    MetricsSnapshot:
      type: object
      required: [intent_counts, status_counts, confirm_outcomes, command_latency_ms]
      properties:
        intent_counts:
          type: object
          additionalProperties:
            type: integer
          description: Count of commands per intent name
          example:
            inbox.list: 42
            pr.summarize: 15
        status_counts:
          type: object
          additionalProperties:
            type: integer
          description: Count of commands per status (ok, needs_confirmation, error)
          example:
            ok: 45
            needs_confirmation: 10
            error: 2
        confirm_outcomes:
          type: object
          additionalProperties:
            type: integer
          description: Count of confirmation outcomes (ok, not_found, error)
          example:
            ok: 8
            not_found: 1
            error: 1
        command_latency_ms:
          type: object
          required: [count]
          properties:
            p50:
              type: number
              nullable: true
              description: 50th percentile (median) latency in milliseconds
            p95:
              type: number
              nullable: true
              description: 95th percentile latency in milliseconds
            count:
              type: integer
              description: Total number of latency samples

    TTSRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
          minLength: 1
          maxLength: 5000
          description: Text to convert to speech
        voice:
          type: string
          description: Optional voice identifier (provider-specific)
        format:
          type: string
          enum: [wav, mp3]
          default: wav
          description: Audio format for the output

    CreateRepoSubscriptionRequest:
      type: object
      required: [repo_full_name]
      properties:
        repo_full_name:
          type: string
          minLength: 1
          description: Full repository name (e.g., "owner/repo")
        installation_id:
          type: integer
          nullable: true
          description: GitHub App installation ID (optional)

    RepoSubscriptionResponse:
      type: object
      required: [id, user_id, repo_full_name, installation_id, created_at]
      properties:
        id:
          type: string
          description: Subscription UUID
        user_id:
          type: string
          description: User UUID
        repo_full_name:
          type: string
          description: Full repository name
        installation_id:
          type: integer
          nullable: true
          description: GitHub App installation ID
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp

    RepoSubscriptionsListResponse:
      type: object
      required: [subscriptions]
      properties:
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/RepoSubscriptionResponse'

    Notification:
      type: object
      required: [id, user_id, event_type, message, metadata, created_at, priority, profile]
      properties:
        id:
          type: string
        user_id:
          type: string
        event_type:
          type: string
        message:
          type: string
        metadata:
          type: object
          additionalProperties: true
        created_at:
          type: string
          format: date-time
        priority:
          type: integer
          minimum: 1
          maximum: 5
        profile:
          type: string
        last_delivery_attempt:
          type: string
          format: date-time
          nullable: true
        delivery_status:
          type: string
          enum: [pending, success, failed]
          nullable: true

    NotificationsListResponse:
      type: object
      required: [notifications, count]
      properties:
        notifications:
          type: array
          items:
            $ref: '#/components/schemas/Notification'
        count:
          type: integer
          minimum: 0

    CreateNotificationSubscriptionRequest:
      type: object
      required: [endpoint]
      properties:
        endpoint:
          type: string
          minLength: 1
          description: Subscription endpoint URL or device token
        platform:
          type: string
          description: "Platform type: webpush, apns, or fcm"
          enum: [webpush, apns, fcm]
          default: webpush
        subscription_keys:
          type: object
          nullable: true
          additionalProperties:
            type: string
          description: Provider-specific subscription keys (e.g., auth, p256dh for WebPush)

    NotificationSubscriptionResponse:
      type: object
      required: [id, user_id, endpoint, platform, subscription_keys, created_at, updated_at]
      properties:
        id:
          type: string
        user_id:
          type: string
        endpoint:
          type: string
        platform:
          type: string
          enum: [webpush, apns, fcm]
        subscription_keys:
          type: object
          additionalProperties:
            type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    NotificationSubscriptionsListResponse:
      type: object
      required: [subscriptions]
      properties:
        subscriptions:
          type: array
          items:
            $ref: '#/components/schemas/NotificationSubscriptionResponse'

    GitHubOAuthStartResponse:
      type: object
      required: [authorize_url]
      properties:
        authorize_url:
          type: string
          format: uri
          description: GitHub OAuth authorization URL to redirect user to
        state:
          type: string
          description: Optional state parameter for CSRF protection

    GitHubOAuthCallbackResponse:
      type: object
      required: [connection_id]
      properties:
        connection_id:
          type: string
          description: ID of the created/updated GitHub connection
        scopes:
          type: string
          description: OAuth scopes granted by the user

    CreateGitHubConnectionRequest:
      type: object
      properties:
        installation_id:
          type: integer
          description: GitHub App installation ID (optional)
        token:
          type: string
          description: GitHub access token (will be stored securely in secret manager)
        token_ref:
          type: string
          description: Reference to token in secret manager (NOT the actual token). Use this OR 'token', not both.
        scopes:
          type: string
          description: Comma-separated OAuth scopes

    GitHubConnectionResponse:
      type: object
      required: [id, user_id, created_at, updated_at]
      properties:
        id:
          type: string
          description: Connection ID
        user_id:
          type: string
          description: User ID that owns this connection
        installation_id:
          type: integer
          description: GitHub App installation ID
        token_ref:
          type: string
          description: Reference to the stored token in secret manager
        scopes:
          type: string
          description: OAuth scopes
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    GitHubConnectionsListResponse:
      type: object
      required: [connections]
      properties:
        connections:
          type: array
          items:
            $ref: '#/components/schemas/GitHubConnectionResponse'

    CreateApiKeyRequest:
      type: object
      properties:
        label:
          type: string
          maxLength: 100
          description: Optional user-friendly label for the key (e.g., 'Mobile app', 'CI/CD')

    ApiKeyResponse:
      type: object
      required: [id, user_id, created_at]
      properties:
        id:
          type: string
          description: API key ID
        user_id:
          type: string
          description: User ID that owns this key
        label:
          type: string
          description: User-friendly label for the key
        created_at:
          type: string
          format: date-time
        revoked_at:
          type: string
          format: date-time
          description: Timestamp when the key was revoked (if applicable)
        last_used_at:
          type: string
          format: date-time
          description: Timestamp when the key was last used (if applicable)

    CreateApiKeyResponse:
      type: object
      required: [key, api_key]
      properties:
        key:
          type: string
          description: The plaintext API key. Save this - it will not be shown again.
        api_key:
          $ref: '#/components/schemas/ApiKeyResponse'

    ApiKeysListResponse:
      type: object
      required: [api_keys]
      properties:
        api_keys:
          type: array
          items:
            $ref: '#/components/schemas/ApiKeyResponse'


