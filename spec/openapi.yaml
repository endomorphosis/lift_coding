openapi: 3.0.3
info:
  title: HandsFree Dev Companion API
  version: 1.0.0
  description: >
    API contract for a hands-free developer assistant (wearable/phone -> backend).
    Designed for fixture-driven testing and safe, policy-gated side effects.
servers:
  - url: http://localhost:8080
paths:
  /v1/command:
    post:
      summary: Submit a hands-free command (text or audio metadata)
      operationId: submitCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
      responses:
        '200':
          description: Command handled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/commands/confirm:
    post:
      summary: Confirm a previously proposed side-effect action
      operationId: confirmCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmRequest'
      responses:
        '200':
          description: Confirmation processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '404':
          description: Pending action not found/expired
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/inbox:
    get:
      summary: Get attention items (PRs, mentions, failing checks)
      operationId: getInbox
      parameters:
        - in: query
          name: profile
          schema: { $ref: '#/components/schemas/Profile' }
          required: false
      responses:
        '200':
          description: Inbox items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InboxResponse'

  /v1/webhooks/github:
    post:
      summary: Receive GitHub webhooks (verified by signature)
      operationId: githubWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Raw GitHub webhook payload
      responses:
        '202':
          description: Accepted
        '400':
          description: Invalid payload or signature
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/actions/request-review:
    post:
      summary: Request reviewers on a PR (policy-gated)
      operationId: requestReview
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RequestReviewRequest' }
      responses:
        '200':
          description: Review request submitted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }
        '409':
          description: Policy denied or needs confirmation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/actions/rerun-checks:
    post:
      summary: Re-run CI checks (policy-gated)
      operationId: rerunChecks
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RerunChecksRequest' }
      responses:
        '200':
          description: Re-run triggered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }

  /v1/actions/merge:
    post:
      summary: Merge a PR (strict policy gate + confirmation)
      operationId: mergePr
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MergeRequest' }
      responses:
        '200':
          description: Merge submitted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }
        '409':
          description: Policy denied or needs confirmation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/github/connections:
    post:
      summary: Create or update GitHub connection metadata
      operationId: createGitHubConnection
      description: >
        Store GitHub App installation metadata for the authenticated user.
        Does NOT store actual tokens - only references to secret manager.
        Scoped per user via X-User-Id header.
      parameters:
        - in: header
          name: X-User-Id
          schema:
            type: string
            format: uuid
          required: false
          description: User ID (defaults to fixture user for dev/testing)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGitHubConnectionRequest'
      responses:
        '201':
          description: Connection created or updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubConnectionResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

    get:
      summary: Get GitHub connection status for authenticated user
      operationId: getGitHubConnections
      description: >
        Returns all GitHub connections for the user (usually 0 or 1).
        Scoped per user via X-User-Id header.
      parameters:
        - in: header
          name: X-User-Id
          schema:
            type: string
            format: uuid
          required: false
          description: User ID (defaults to fixture user for dev/testing)
      responses:
        '200':
          description: Connection details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubConnectionsListResponse'

  /v1/github/connections/{connection_id}:
    get:
      summary: Get a specific GitHub connection by ID
      operationId: getGitHubConnectionById
      description: >
        Get a specific GitHub connection. Users can only access their own connections.
      parameters:
        - in: path
          name: connection_id
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the connection to retrieve
        - in: header
          name: X-User-Id
          schema:
            type: string
            format: uuid
          required: false
          description: User ID (defaults to fixture user for dev/testing)
      responses:
        '200':
          description: Connection details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GitHubConnectionResponse'
        '404':
          description: Connection not found or not owned by user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
    delete:
      summary: Delete a GitHub connection
      operationId: deleteGitHubConnection
      description: >
        Delete a GitHub connection. Users can only delete their own connections.
      parameters:
        - in: path
          name: connection_id
          required: true
          schema:
            type: string
            format: uuid
          description: UUID of the connection to delete
        - in: header
          name: X-User-Id
          schema:
            type: string
            format: uuid
          required: false
          description: User ID (defaults to fixture user for dev/testing)
      responses:
        '204':
          description: Connection deleted
        '404':
          description: Connection not found or not owned by user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

components:
  schemas:
    Profile:
      type: string
      enum: [workout, kitchen, commute, default]
      default: default

    CommandRequest:
      type: object
      required: [input, profile, client_context]
      properties:
        input:
          $ref: '#/components/schemas/CommandInput'
        profile:
          $ref: '#/components/schemas/Profile'
        client_context:
          $ref: '#/components/schemas/ClientContext'
        idempotency_key:
          type: string
          description: Client-provided idempotency key for de-duping.

    CommandInput:
      type: object
      oneOf:
        - $ref: '#/components/schemas/TextInput'
        - $ref: '#/components/schemas/AudioInput'
      discriminator:
        propertyName: type
        mapping:
          text: '#/components/schemas/TextInput'
          audio: '#/components/schemas/AudioInput'

    TextInput:
      type: object
      required: [type, text]
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string
          maxLength: 2000

    AudioInput:
      type: object
      required: [type, format, uri]
      properties:
        type:
          type: string
          enum: [audio]
        format:
          type: string
          enum: [wav, m4a, mp3, opus]
        uri:
          type: string
          description: Where the backend can fetch the audio (pre-signed URL) or a local dev placeholder.
        duration_ms:
          type: integer
          minimum: 0

    ClientContext:
      type: object
      required: [device, locale, timezone, app_version]
      properties:
        device:
          type: string
          description: e.g. ios, android, simulator
        locale:
          type: string
          example: en-US
        timezone:
          type: string
          example: America/Los_Angeles
        app_version:
          type: string
          example: 0.1.0
        noise_mode:
          type: boolean
          default: false

    CommandResponse:
      type: object
      required: [spoken_text, intent, status]
      properties:
        status:
          type: string
          enum: [ok, needs_confirmation, error]
        intent:
          $ref: '#/components/schemas/ParsedIntent'
        spoken_text:
          type: string
          description: Text that should be sent to TTS.
        cards:
          type: array
          items: { $ref: '#/components/schemas/UICard' }
        pending_action:
          $ref: '#/components/schemas/PendingAction'
        debug:
          $ref: '#/components/schemas/DebugInfo'

    ParsedIntent:
      type: object
      required: [name, confidence]
      properties:
        name:
          type: string
          example: inbox.list
          description: >
            Intent name parsed from the command. Supported intents include:
            - inbox.list: Query inbox items
            - pr.summarize: Summarize a pull request
            - pr.merge: Merge a pull request (policy-gated)
            - agent.delegate: Delegate a task to an agent
            - agent.status: Query status of agent tasks
        confidence:
          type: number
          minimum: 0
          maximum: 1
        entities:
          type: object
          additionalProperties: true
          description: >
            Extracted entities specific to the intent. Examples:
            - pr_number (int): PR number for pr.* intents
            - issue_number (int): Issue number for agent.delegate
            - task_id (string): Agent task ID for agent.delegate
            - instruction (string): Task instruction for agent.delegate

    PendingAction:
      type: object
      required: [token, expires_at, summary]
      properties:
        token:
          type: string
        expires_at:
          type: string
          format: date-time
        summary:
          type: string
          description: Human-readable action summary for confirmation.

    UICard:
      type: object
      required: [title]
      properties:
        title:
          type: string
        subtitle:
          type: string
        lines:
          type: array
          items: { type: string }
        deep_link:
          type: string
          description: Optional link to open on phone.

    DebugInfo:
      type: object
      properties:
        transcript:
          type: string
        tool_calls:
          type: array
          items:
            type: object
            additionalProperties: true

    ConfirmRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
        idempotency_key:
          type: string

    InboxResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/InboxItem' }

    InboxItem:
      type: object
      required: [type, title, priority]
      properties:
        type:
          type: string
          enum: [pr, mention, check, agent]
        title:
          type: string
        priority:
          type: integer
          minimum: 1
          maximum: 5
        repo:
          type: string
        url:
          type: string
        summary:
          type: string

    RequestReviewRequest:
      type: object
      required: [repo, pr_number, reviewers]
      properties:
        repo: { type: string, example: owner/name }
        pr_number: { type: integer, minimum: 1 }
        reviewers:
          type: array
          items: { type: string }
        idempotency_key: { type: string }

    RerunChecksRequest:
      type: object
      required: [repo, pr_number]
      properties:
        repo: { type: string }
        pr_number: { type: integer, minimum: 1 }
        idempotency_key: { type: string }

    MergeRequest:
      type: object
      required: [repo, pr_number]
      properties:
        repo: { type: string }
        pr_number: { type: integer, minimum: 1 }
        merge_method:
          type: string
          enum: [merge, squash, rebase]
          default: squash
        idempotency_key: { type: string }

    ActionResult:
      type: object
      required: [ok, message]
      properties:
        ok: { type: boolean }
        message: { type: string }
        url: { type: string }

    Error:
      type: object
      required: [error, message]
      properties:
        error: { type: string }
        message: { type: string }
        details:
          type: object
          additionalProperties: true

    CreateGitHubConnectionRequest:
      type: object
      properties:
        installation_id:
          type: integer
          description: GitHub App installation ID
        token_ref:
          type: string
          description: Reference to token in secret manager (NOT the actual token)
        scopes:
          type: string
          description: Comma-separated OAuth scopes

    GitHubConnectionResponse:
      type: object
      required: [id, user_id, created_at, updated_at]
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        installation_id:
          type: integer
        token_ref:
          type: string
        scopes:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    GitHubConnectionsListResponse:
      type: object
      required: [connections]
      properties:
        connections:
          type: array
          items:
            $ref: '#/components/schemas/GitHubConnectionResponse'
