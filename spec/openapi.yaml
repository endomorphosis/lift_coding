openapi: 3.0.3
info:
  title: HandsFree Dev Companion API
  version: 1.0.0
  description: >
    API contract for a hands-free developer assistant (wearable/phone -> backend).
    Designed for fixture-driven testing and safe, policy-gated side effects.
servers:
  - url: http://localhost:8080
paths:
  /v1/command:
    post:
      summary: Submit a hands-free command (text or audio metadata)
      operationId: submitCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
      responses:
        '200':
          description: Command handled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '401':
          description: Not authenticated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/commands/confirm:
    post:
      summary: Confirm a previously proposed side-effect action
      operationId: confirmCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfirmRequest'
      responses:
        '200':
          description: Confirmation processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '404':
          description: Pending action not found/expired
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/inbox:
    get:
      summary: Get attention items (PRs, mentions, failing checks)
      operationId: getInbox
      parameters:
        - in: query
          name: profile
          schema: { $ref: '#/components/schemas/Profile' }
          required: false
      responses:
        '200':
          description: Inbox items
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InboxResponse'

  /v1/status:
    get:
      summary: Get service status
      operationId: getStatus
      description: >
        Lightweight health/status endpoint for the mobile app and simulator.
        Returns service status, version, timestamp, and dependency readiness
        (e.g., DuckDB). Does not expose sensitive configuration values.
      responses:
        '200':
          description: Service status information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  /v1/metrics:
    get:
      summary: Get observability metrics
      operationId: getMetrics
      description: >
        Returns lightweight observability metrics for the command flow.
        Gated behind HANDSFREE_ENABLE_METRICS environment variable.
        Includes command latency percentiles (p50/p95), intent counts,
        status counts, and confirmation outcomes.
      responses:
        '200':
          description: Metrics snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsSnapshot'
        '404':
          description: Metrics not enabled
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/webhooks/github:
    post:
      summary: Receive GitHub webhooks (verified by signature)
      operationId: githubWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Raw GitHub webhook payload
      responses:
        '202':
          description: Accepted
        '400':
          description: Invalid payload or signature
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/actions/request-review:
    post:
      summary: Request reviewers on a PR (policy-gated)
      operationId: requestReview
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RequestReviewRequest' }
      responses:
        '200':
          description: Review request submitted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }
        '409':
          description: Policy denied or needs confirmation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/actions/rerun-checks:
    post:
      summary: Re-run CI checks (policy-gated)
      operationId: rerunChecks
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/RerunChecksRequest' }
      responses:
        '200':
          description: Re-run triggered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }

  /v1/actions/merge:
    post:
      summary: Merge a PR (strict policy gate + confirmation)
      operationId: mergePr
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MergeRequest' }
      responses:
        '200':
          description: Merge submitted
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ActionResult' }
        '409':
          description: Policy denied or needs confirmation
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

  /v1/tts:
    post:
      summary: Convert text to speech (TTS)
      operationId: textToSpeech
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TTSRequest'
      responses:
        '200':
          description: Audio file generated successfully
          content:
            audio/wav:
              schema:
                type: string
                format: binary
            audio/mpeg:
              schema:
                type: string
                format: binary
        '400':
          description: Invalid request (empty or too long text)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }
        '500':
          description: TTS synthesis failed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Error' }

components:
  schemas:
    Profile:
      type: string
      enum: [workout, kitchen, commute, default]
      default: default

    CommandRequest:
      type: object
      required: [input, profile, client_context]
      properties:
        input:
          $ref: '#/components/schemas/CommandInput'
        profile:
          $ref: '#/components/schemas/Profile'
        client_context:
          $ref: '#/components/schemas/ClientContext'
        idempotency_key:
          type: string
          description: Client-provided idempotency key for de-duping.

    CommandInput:
      type: object
      oneOf:
        - $ref: '#/components/schemas/TextInput'
        - $ref: '#/components/schemas/AudioInput'
      discriminator:
        propertyName: type
        mapping:
          text: '#/components/schemas/TextInput'
          audio: '#/components/schemas/AudioInput'

    TextInput:
      type: object
      required: [type, text]
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string
          maxLength: 2000

    AudioInput:
      type: object
      required: [type, format, uri]
      properties:
        type:
          type: string
          enum: [audio]
        format:
          type: string
          enum: [wav, m4a, mp3, opus]
        uri:
          type: string
          description: Where the backend can fetch the audio (pre-signed URL) or a local dev placeholder.
        duration_ms:
          type: integer
          minimum: 0

    ClientContext:
      type: object
      required: [device, locale, timezone, app_version]
      properties:
        device:
          type: string
          description: e.g. ios, android, simulator
        locale:
          type: string
          example: en-US
        timezone:
          type: string
          example: America/Los_Angeles
        app_version:
          type: string
          example: 0.1.0
        noise_mode:
          type: boolean
          default: false
        debug:
          type: boolean
          default: false
          description: Enable debug mode to store transcript for troubleshooting

    CommandResponse:
      type: object
      required: [spoken_text, intent, status]
      properties:
        status:
          type: string
          enum: [ok, needs_confirmation, error]
        intent:
          $ref: '#/components/schemas/ParsedIntent'
        spoken_text:
          type: string
          description: Text that should be sent to TTS.
        cards:
          type: array
          items: { $ref: '#/components/schemas/UICard' }
        pending_action:
          $ref: '#/components/schemas/PendingAction'
        debug:
          $ref: '#/components/schemas/DebugInfo'

    ParsedIntent:
      type: object
      required: [name, confidence]
      properties:
        name:
          type: string
          example: inbox.list
          description: >
            Intent name parsed from the command. Supported intents include:
            - inbox.list: Query inbox items
            - pr.summarize: Summarize a pull request
            - pr.merge: Merge a pull request (policy-gated)
            - agent.delegate: Delegate a task to an agent
            - agent.status: Query status of agent tasks
        confidence:
          type: number
          minimum: 0
          maximum: 1
        entities:
          type: object
          additionalProperties: true
          description: >
            Extracted entities specific to the intent. Examples:
            - pr_number (int): PR number for pr.* intents
            - issue_number (int): Issue number for agent.delegate
            - task_id (string): Agent task ID for agent.delegate
            - instruction (string): Task instruction for agent.delegate

    PendingAction:
      type: object
      required: [token, expires_at, summary]
      properties:
        token:
          type: string
        expires_at:
          type: string
          format: date-time
        summary:
          type: string
          description: Human-readable action summary for confirmation.

    UICard:
      type: object
      required: [title]
      properties:
        title:
          type: string
        subtitle:
          type: string
        lines:
          type: array
          items: { type: string }
        deep_link:
          type: string
          description: Optional link to open on phone.

    DebugInfo:
      type: object
      properties:
        transcript:
          type: string
        tool_calls:
          type: array
          items:
            type: object
            additionalProperties: true

    ConfirmRequest:
      type: object
      required: [token]
      properties:
        token:
          type: string
        idempotency_key:
          type: string

    InboxResponse:
      type: object
      required: [items]
      properties:
        items:
          type: array
          items: { $ref: '#/components/schemas/InboxItem' }

    InboxItem:
      type: object
      required: [type, title, priority]
      properties:
        type:
          type: string
          enum: [pr, mention, check, agent]
        title:
          type: string
        priority:
          type: integer
          minimum: 1
          maximum: 5
        repo:
          type: string
        url:
          type: string
        summary:
          type: string
        checks_passed:
          type: integer
          minimum: 0
          description: Number of checks that passed
        checks_failed:
          type: integer
          minimum: 0
          description: Number of checks that failed
        checks_pending:
          type: integer
          minimum: 0
          description: Number of checks that are pending or in progress

    RequestReviewRequest:
      type: object
      required: [repo, pr_number, reviewers]
      properties:
        repo: { type: string, example: owner/name }
        pr_number: { type: integer, minimum: 1 }
        reviewers:
          type: array
          items: { type: string }
        idempotency_key: { type: string }

    RerunChecksRequest:
      type: object
      required: [repo, pr_number]
      properties:
        repo: { type: string }
        pr_number: { type: integer, minimum: 1 }
        idempotency_key: { type: string }

    MergeRequest:
      type: object
      required: [repo, pr_number]
      properties:
        repo: { type: string }
        pr_number: { type: integer, minimum: 1 }
        merge_method:
          type: string
          enum: [merge, squash, rebase]
          default: squash
        idempotency_key: { type: string }

    ActionResult:
      type: object
      required: [ok, message]
      properties:
        ok: { type: boolean }
        message: { type: string }
        url: { type: string }

    Error:
      type: object
      required: [error, message]
      properties:
        error: { type: string }
        message: { type: string }
        details:
          type: object
          additionalProperties: true

    DependencyStatus:
      type: object
      required: [name, status]
      properties:
        name:
          type: string
          description: Name of the dependency (e.g., duckdb, redis)
        status:
          type: string
          enum: [ok, degraded, unavailable]
          description: Status of the dependency
        message:
          type: string
          description: Optional message with additional details

    StatusResponse:
      type: object
      required: [status, timestamp]
      properties:
        status:
          type: string
          enum: [ok, degraded, unavailable]
          description: Overall service status
        version:
          type: string
          description: Service version if available
        timestamp:
          type: string
          format: date-time
          description: Current server time (ISO 8601)
        dependencies:
          type: array
          items:
            $ref: '#/components/schemas/DependencyStatus'
          description: Status of service dependencies

    MetricsSnapshot:
      type: object
      required: [intent_counts, status_counts, confirm_outcomes, command_latency_ms]
      properties:
        intent_counts:
          type: object
          additionalProperties:
            type: integer
          description: Count of commands per intent name
          example:
            inbox.list: 42
            pr.summarize: 15
        status_counts:
          type: object
          additionalProperties:
            type: integer
          description: Count of commands per status (ok, needs_confirmation, error)
          example:
            ok: 45
            needs_confirmation: 10
            error: 2
        confirm_outcomes:
          type: object
          additionalProperties:
            type: integer
          description: Count of confirmation outcomes (ok, not_found, error)
          example:
            ok: 8
            not_found: 1
            error: 1
        command_latency_ms:
          type: object
          required: [count]
          properties:
            p50:
              type: number
              nullable: true
              description: 50th percentile (median) latency in milliseconds
            p95:
              type: number
              nullable: true
              description: 95th percentile latency in milliseconds
            count:
              type: integer
              description: Total number of latency samples

    TTSRequest:
      type: object
      required: [text]
      properties:
        text:
          type: string
          minLength: 1
          maxLength: 5000
          description: Text to convert to speech
        voice:
          type: string
          description: Optional voice identifier (provider-specific)
        format:
          type: string
          enum: [wav, mp3]
          default: wav
          description: Audio format for the output
